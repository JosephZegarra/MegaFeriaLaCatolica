<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Mega Feria</title>
    <link rel="stylesheet" th:href="@{/css/christi-theme.css}">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body body class="bg-green-50 text-gray-800 min-h-screen flex flex-col">

<div th:replace="Orden/Head :: common-header"></div>

<main class="max-w-7xl mx-auto p-6">

    <!-- ---------- TARJETAS KPI ---------- -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">

        <div class="bg-white p-6 rounded-lg shadow">
            <h3 class="text-sm text-gray-600">Total Socios</h3>
            <p class="text-3xl font-bold text-green-800"
               th:text="${dashboardData.totalSocios}">0</p>
        </div>

        <div class="bg-white p-6 rounded-lg shadow">
            <h3 class="text-sm text-gray-600">Activos</h3>
            <p class="text-3xl font-bold text-blue-700"
               th:text="${dashboardData.sociosActivos}">0</p>
        </div>

        <div class="bg-white p-6 rounded-lg shadow">
            <h3 class="text-sm text-gray-600">Inactivos</h3>
            <p class="text-3xl font-bold text-gray-700"
               th:text="${dashboardData.sociosInactivos}">0</p>
        </div>

        <div class="bg-white p-6 rounded-lg shadow">
            <h3 class="text-sm text-gray-600">Bloqueados</h3>
            <p class="text-3xl font-bold text-red-700"
               th:text="${dashboardData.sociosBloqueados}">0</p>
        </div>

    </div>

    <!-- ---------- GR츼FICO TENDENCIA ----------->
    <!--
    <div class="bg-white p-6 rounded-lg shadow mb-6">
        <h3 class="text-lg font-semibold">Tendencia de Asistencia (칰ltimos 7 d칤as)</h3>
        <canvas id="chartTendencia" height="120"></canvas>
    </div>
    -->


    <div class="bg-white p-6 rounded-lg shadow mb-6">
        <h3 class="text-lg font-semibold mb-4">Ingresos / Egresos (칔ltimos 7 d칤as)</h3>
        
        <!-- Controles de exportaci칩n -->
        <div class="mb-4 flex gap-4 items-end">
            <div>
                <label for="mesMovimientos" class="block text-sm font-medium text-gray-700 mb-1">Mes</label>
                <select id="mesMovimientos" class="border border-gray-300 rounded px-3 py-2">
                    <option value="">Seleccionar mes</option>
                    <option value="1">Enero</option>
                    <option value="2">Febrero</option>
                    <option value="3">Marzo</option>
                    <option value="4">Abril</option>
                    <option value="5">Mayo</option>
                    <option value="6">Junio</option>
                    <option value="7">Julio</option>
                    <option value="8">Agosto</option>
                    <option value="9">Septiembre</option>
                    <option value="10">Octubre</option>
                    <option value="11">Noviembre</option>
                    <option value="12">Diciembre</option>
                </select>
            </div>
            
            <div>
                <label for="anioMovimientos" class="block text-sm font-medium text-gray-700 mb-1">A침o</label>
                <select id="anioMovimientos" class="border border-gray-300 rounded px-3 py-2">
                    <option value="">Seleccionar a침o</option>
                </select>
            </div>
            
            <button onclick="exportarMovimientos()" 
                    class="bg-green-600 hover:bg-green-700 text-white font-semibold px-4 py-2 rounded transition duration-200">
                游닌 Exportar a Excel
            </button>
        </div>
        
        <table class="w-full text-left border-collapse">
            <thead>
            <tr class="border-b bg-green-200">
                <th class="py-2 px-4">Fecha</th>
                <th class="py-2 px-4">Ingresos</th>
                <th class="py-2 px-4">Egresos</th>
                <th class="py-2 px-4">Saldo</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="m : ${movimientos}" class="border-b bg-white hover:bg-green-50 transition duration-150">
                <td class="py-2 px-4" th:text="${m.fecha}"></td>
                <td class="py-2 px-4" th:text="${m.ingresos}"></td>
                <td class="py-2 px-4" th:text="${m.egresos}"></td>
                <td class="py-2 px-4" th:text="${m.saldo}"></td>
            </tr>
            </tbody>
        </table>
    </div>





    <!-- ---------- RESUMEN ASISTENCIA DIARIA ---------- -->
    <div class="bg-white p-6 rounded-lg shadow mb-6">
        <h3 class="text-lg font-semibold mb-4">Asistencia Diaria (칰ltimos 7 d칤as)</h3>

        <!-- Controles de exportaci칩n -->
        <div class="mb-4 flex gap-4 items-end">
            <div>
                <label for="mesAsistencias" class="block text-sm font-medium text-gray-700 mb-1">Mes</label>
                <select id="mesAsistencias" class="border border-gray-300 rounded px-3 py-2">
                    <option value="">Seleccionar mes</option>
                    <option value="1">Enero</option>
                    <option value="2">Febrero</option>
                    <option value="3">Marzo</option>
                    <option value="4">Abril</option>
                    <option value="5">Mayo</option>
                    <option value="6">Junio</option>
                    <option value="7">Julio</option>
                    <option value="8">Agosto</option>
                    <option value="9">Septiembre</option>
                    <option value="10">Octubre</option>
                    <option value="11">Noviembre</option>
                    <option value="12">Diciembre</option>
                </select>
            </div>
            
            <div>
                <label for="anioAsistencias" class="block text-sm font-medium text-gray-700 mb-1">A침o</label>
                <select id="anioAsistencias" class="border border-gray-300 rounded px-3 py-2">
                    <option value="">Seleccionar a침o</option>
                </select>
            </div>
            
            <button onclick="exportarAsistencias()" 
                    class="bg-green-600 hover:bg-green-700 text-white font-semibold px-4 py-2 rounded transition duration-200">
                游닌 Exportar a Excel
            </button>
        </div>

        <table class="w-full text-left border-collapse">
            <thead>
            <tr class="border-b bg-green-200">
                <th class="py-2 px-4">Fecha</th>
                <th class="py-2 px-4">Presentes</th>
                <th class="py-2 px-4">Ausentes</th>
                <th class="py-2 px-4">Justificados</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="row : ${dashboardData.asistenciaDiaria}" class="border-b bg-white hover:bg-green-50 transition duration-150">
                <td class="py-2 px-4" th:text="${row.fecha}">2025-12-01</td>
                <td class="py-2 px-4" th:text="${row.totalPresente}">0</td>
                <td class="py-2 px-4" th:text="${row.totalAusente}">0</td>
                <td class="py-2 px-4" th:text="${row.totalJustificado}">0</td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- ---------- ESTADO DE ASISTENCIA ---------- -->
    <div class="bg-white p-6 rounded-lg shadow mb-6">
        <h3 class="text-lg font-semibold">Asistencia por Estado</h3>
        <canvas id="chartEstado" height="120"></canvas>
    </div>

    <!-- ---------- TOP DEUDORES ---------- -->
    <div class="bg-white p-6 rounded-lg shadow">
        <h3 class="text-lg font-semibold mb-4">Top Deudores</h3>

        <table class="w-full">
            <thead>
            <tr class="border-b">
                <th class="text-left py-2">Socio</th>
                <th class="text-right py-2">Total Deuda (S/)</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="row : ${dashboardData.topDeudores}" class="border-b">
                <td class="py-2" th:text="${row[0]}">Nombre</td>
                <td class="py-2 text-right" th:text="${row[1]}">0</td>
            </tr>
            </tbody>
        </table>

    </div>

</main>
<div th:replace="Orden/Footer :: common-footer"></div>
<!-- ================================
     JAVASCRIPT PARA LOS GR츼FICOS
================================ -->
<script th:inline="javascript">
    // -------------------------------
    // ESTADO DE ASISTENCIA
    // -------------------------------
    let estado = /*[[${dashboardData.asistenciaEstado}]]*/ [];

    let estadoLabels = estado.map(item => item[0]);
    let estadoValues = estado.map(item => Number(item[1]));

    new Chart(document.getElementById('chartEstado'), {
    type: 'bar',
    data: {
        labels: estadoLabels,
        datasets: [{
            label: 'Cantidad',
            data: estadoValues,
            backgroundColor: ['#2E7D32','#66BB6A','#A5D6A7'] // verdes de tu branding
        }]
    },
    options: {
        plugins: {
            legend: { labels: { color: '#1B5E20', font: { weight: 'bold' } } }
        },
        scales: {
            x: { ticks: { color: '#1B5E20' } },
            y: { ticks: { color: '#1B5E20' } }
        }
    }
});

// ================================
// FUNCIONES DE EXPORTACI칍N
// ================================

// Poblar selectores de a침o al cargar la p치gina
window.addEventListener('DOMContentLoaded', function() {
    const currentYear = new Date().getFullYear();
    const years = [];
    
    // Generar a침os desde 4 a침os atr치s hasta el pr칩ximo a침o
    for (let year = currentYear - 4; year <= currentYear + 1; year++) {
        years.push(year);
    }
    
    // Poblar selector de a침os para movimientos
    const selectAnioMovimientos = document.getElementById('anioMovimientos');
    years.forEach(year => {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        if (year === currentYear) {
            option.selected = true;
        }
        selectAnioMovimientos.appendChild(option);
    });
    
    // Poblar selector de a침os para asistencias
    const selectAnioAsistencias = document.getElementById('anioAsistencias');
    years.forEach(year => {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        if (year === currentYear) {
            option.selected = true;
        }
        selectAnioAsistencias.appendChild(option);
    });
    
    // Pre-seleccionar el mes actual
    const currentMonth = new Date().getMonth() + 1; // getMonth() devuelve 0-11
    document.getElementById('mesMovimientos').value = currentMonth;
    document.getElementById('mesAsistencias').value = currentMonth;
});

/**
 * Exportar movimientos (Ingresos/Egresos) a Excel
 */
function exportarMovimientos() {
    const mes = document.getElementById('mesMovimientos').value;
    const anio = document.getElementById('anioMovimientos').value;
    
    if (!mes || !anio) {
        alert('Por favor seleccione el mes y el a침o antes de exportar.');
        return;
    }
    
    // Redirigir al endpoint de exportaci칩n
    window.location.href = `/Dashboard/exportar-movimientos?mes=${mes}&anio=${anio}`;
}

/**
 * Exportar asistencias a Excel
 */
function exportarAsistencias() {
    const mes = document.getElementById('mesAsistencias').value;
    const anio = document.getElementById('anioAsistencias').value;
    
    if (!mes || !anio) {
        alert('Por favor seleccione el mes y el a침o antes de exportar.');
        return;
    }
    
    // Redirigir al endpoint de exportaci칩n
    window.location.href = `/Dashboard/exportar-asistencias?mes=${mes}&anio=${anio}`;
}

</script>
</body>
</html>
